<script type="text/babel">

    $(document).ready(init_js);
    var buttonpressed;
    var personIndex;
    function init_js() {
      $(".submit.button").click(function() {
        buttonpressed = $(this).attr("name");
      });
  
      formValidation();
      loadAcademicProgramsAndFaculties();
      $(".ui.radio.checkbox").checkbox();
      $("select.dropdown").dropdown();
      $(".ui.modal").modal();
      $(".ui.modal").modal('setting', 'closable', false)

      $(".numeric").on("keypress", function(e) {
        return (
          e.metaKey || // cmd/ctrl
          e.which <= 0 || // arrow keys
          e.which == 8 || // delete key
          /[0-9]/.test(String.fromCharCode(e.which))
        ); // numbers
      });
    
      $("#busca-cedula").on("keyup", function(event) {
        event.preventDefault();
        // Number 13 is the "Enter" key on the keyboard
        if (event.keyCode === 13) {
          // Trigger the button element with a click
          document.getElementById("btn-search").click();
        }
      });
    }
    
    function validationpassed(e) {
      try {
        e.preventDefault();
        var mForm = $(".ui.form");
        var formData = mForm.serializeArray()
        mForm.addClass("loading");

         formData.push({name: 'doc_file', value: 'SRA'});
          addPayment(formData)
        
  
      } catch (error) {
        $(".ui.error.message").text(error.toString());
      }
    }
  
    function addPayment(formData){
            console.log('all is ok', buttonpressed)
            // if (buttonpressed == "submit-btn") {
              formData.push({ name: "pago_generado", value: "NO" });
            // }   
  
            var index_vegana = -1;
            var vegana = formData.find((field, index) => {
              index_vegana = index;
              return field.name == "cena_vegana";
            });
            console.log(vegana);
            if (index_vegana > -1 && vegana) {
              if (formData[index_vegana].value == "on") {
                formData[index_vegana].value = "SI";
              } else {
                formData[index_vegana].value = "NO";
              }
            } else {
              formData.push({ name: "cena_vegana", value: "NO" });
            }
  
            console.log('form',formData)
            registerPersonInSheet(formData);
    }
    
    function registerPersonInSheet(formData) {
      function onSuccess(response) {
        if (response.ok) {
          $(".ui.form").removeClass("loading");
  
          $("#result-msg").text('')
          $("#result-msg").text(
              "Su inscripción a la Cena de Gala Egresados 2018 fue realizada de manera exitosa. Recuerde que usted cuenta con 48 horas para generar su pago. Pasadas estas 48 horas, el sistema deshabilitará la inscripción."
           );
          $(".ui.modal").modal("show");
          $('.actions').css('display', 'block')
  
        } else {
          console.log("You fucked up", response);
        }
      }
      console.log(formData);
      google.script.run.withSuccessHandler(onSuccess).registerPerson(formData);
    }
    
    function searchForPerson() {
      hideForm();
      $("#btn-search").addClass("loading");
    
      var onSuccess = function(person) {
        if (person) {
          showForm();
          $(".ui.form").addClass("loading");
          console.log("A nice formatted person", person);
          $("#btn-search").removeClass("loading");
          $("input[name='cedula']").prop("readonly", true);
          $("input[name='cedula']").addClass("not-allowed");
          if (person.isRegistered) {
            loadPersonInForm(person);
          }
        } else {
          console.log("Something went wrong searching user...");
        }
      };
    
      var cedula = $("#busca-cedula").val();
      if (cedula.length > 0) {
        google.script.run.withSuccessHandler(onSuccess).searchPerson(cedula);
      } else {
        $("#btn-search").removeClass("loading");
        $("#search-msg").html("Por favor ingrese una cedula");
        $("#search-msg").css("display", "block");
        setTimeout(function(){
          $("#search-msg").html("Por favor ingrese una cedula");
          $("#search-msg").css("display", "none");  
        }, 3000)
      }
    }
    
    function disableFormFielfds(bool) {
      if (bool) {
        $("input:not([name='busca-cedula'])").prop("readonly", true);
        $("input:not([name='busca-cedula'])").addClass("not-allowed");
        $(".ui.checkbox").checkbox();
        $(".ui.checkbox").prop("read-only", false);
        $(".ui.checkbox").addClass("not-allowed");
       $("input[type='checkbox']").addClass("not-allowed");
      } else {
        $("input:not([name='busca-cedula'])").prop("readonly", false);
        $("input:not([name='busca-cedula'])").removeClass("not-allowed"); 
        $(".ui.checkbox").checkbox();
        $(".ui.checkbox").prop("read-only", false);
        $(".ui.checkbox").removeClass("not-allowed");
        $("input[type='checkbox']").removeClass("not-allowed");
  
      }
    }

    
    function loadPersonInForm(person) {
      console.log("Person in form", person);
      personIndex = Number(person.index) + 1;
      $("input[name='nombres']").val(person.data.nombres);
      $("input[name='apellidos']").val(person.data.apellidos);
      $("input[name='cedula']").val(person.data.cedula);
      $("input[name='correo']").val(person.data.correo);
      $("input[name='celular']").val(person.data.celular);
      $("select[name='programa']").dropdown("set selected", person.data.programa);
      $("select[name='facultad']").dropdown("set selected", person.data.facultad);
      if (person.data["cena_vegana"] == "SI") {
        $("input[name='cena_vegana']").prop("checked", true);
      } else {
        $("input[name='cena_vegana']").prop("checked", false);
      }
      if (person.data["pago_comprobado"] == "SI") {
        $("#pay-msg").removeClass("not-visible");
             $("#pay-msg").removeClass("warning");
       $("#pay-msg").addClass("success");
        $("#pay-msg").append( `<i class="icon check circle"></i>
            El pago de su inscripción a la Noche de Gala de Egresados fue registrado satisfactoriamente. Le esperamos el
            próximo 23 de Noviembre de 2018.
            Si presenta alguna dificultad en el proceso de inscripción, por favor escribanos al correo electrónico soyegresado@correounivalle.edu.co
          </div>`);
      }else{
       $("#pay-msg").removeClass("not-visible");
       $("#pay-msg").removeClass("success");
       $("#pay-msg").addClass("warning");
  
        $("#pay-msg").append( `<i class="icon warning "></i>
            El pago de su inscripción aun no ha sido registrado. Recuerde que después de 48 horas sin registrar el pago, el sistema anulará su inscripción.
            Si presenta alguna dificultad en el proceso de inscripción, por favor escribanos al correo electrónico soyegresado@correounivalle.edu.co
          </div>`);
  
      }
  
      $(".ui.dropdown").addClass("disabled");
      $(".fields.regreso").addClass("not-allowed");
      $(".file-field").addClass("not-visible");
      $("#submit-btn").addClass("not-visible");
      $("#submit-pay-btn").addClass("not-visible");
      if (person.data["pago_generado"] == "NO") {
        $("#register-pay-btn").removeClass("not-visible");
        $("#register-pay-btn").addClass("visible");
      }
      $("input[name='politicas']").prop("checked", true);
      disableFormFielfds(true);
      $(".ui.form").removeClass("loading");
  
    }
      
    function submitPayment() {
      $("#register-pay-btn").addClass("loading");
    
      if (personIndex > -1) {
        function onSuccess(result) {
          $("#register-pay-btn").removeClass("loading");
          if (result) {
            console.log("result", result);
            hideForm()
            return true
          }
        }
        return google.script.run
          .withSuccessHandler(onSuccess)
          .generatePayment(personIndex);
      }
    } 
  
    function showForm() {
      $("#mainForm").css("display", "block");
      $("ui.submit.button").css("display", "block");
      $("input[name='cedula']").val($("#busca-cedula").val());
      disableFormFielfds(false);
    }
    
    function hideForm() {
      $("#mainForm").css("display", "none");
      $(".fields.regreso").removeClass("not-allowed");
      $(".file-field").removeClass("not-visible");
      $("#submit-btn").removeClass("not-visible");
      $("#submit-pay-btn").removeClass("not-visible");
      $("input[name='politicas']").prop("checked", false);
      $("input[name='cena_vegana']").prop("checked", false);
      $(".dropdown").dropdown();
      $(".ui.dropdown").removeClass("disabled");
       $(".fields.regreso").removeClass("not-allowed");
       $("#pay-msg").addClass("not-visible")
       $("#pay-msg").text("")
  
      disableFormFielfds(false);
      $(".ui.form").form("clear");
    }
    function loadAcademicProgramsAndFaculties() {
    function onSuccess(result) {
      console.log("good job", result);
      if (result) {
        $.each(result.programs, function(i, program) {
          $("select[name='programa']").append(
            $("<option>", {
              value: program.nombre,
              text: program.nombre
            })
          );
        });
  
        $.each(result.faculties, function(i, faculty) {
          $("select[name='facultad']").append(
            $("<option>", {
              value: faculty,
              text: faculty
            })
          );
        });
  
        $("select[name='programa']").on("change", function(e) {
          $.each(result.programs, function(i, program) {
            if (e.target.value == program.nombre) {
              $("select[name='facultad']").val(program.facultad);
              $("select[name='facultad']").trigger("change");
              return false;
            }
          });
        });
      }
    }
    google.script.run.withSuccessHandler(onSuccess).getFacultiesAndPrograms();
  }
    function formValidation() {
      $(".ui.form").form({
        inline: true,
        on: "blur",
        transition: "fade down",
        onSuccess: validationpassed,
        fields: {
          cedula: {
            identifier: "cedula",
            rules: [
              {
                type: "number",
                prompt: "Por favor ingrese una cedula valido"
              },
              {
                type: "empty",
                prompt: "Por favor ingrese una cedula"
              }
            ]
          },

        }
      });
    }
    
    </script>